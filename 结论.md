ä¸€ã€æ ¸å¿ƒç»“è®ºå…ˆæ”¾è¿™ï¼ˆä½ æŒ‰è¿™ä¸ªåšï¼‰

ç›´æ’­ï¼ˆlive.bilibili.comï¼‰å¿…é¡»ï¼š

âŒ ä¸æ”¹ Header

âŒ ä¸æ³¨ Cookie

âŒ ä¸åˆ  CSP / XFO

âŒ ä¸åŠ¨ Origin / Referer

âœ… åªç”¨ Electron çš„åŸç”Ÿ session cookie

âœ… ä½¿ç”¨ç‹¬ç«‹ã€å¹²å‡€çš„ session é…ç½®

ä¸€å¥è¯ï¼šç›´æ’­ = é›¶åŠ«æŒã€‚

äºŒã€ä½ ç°åœ¨â€œå¿…é¡» if (isLive) returnâ€çš„åœ°æ–¹ï¼ˆæ˜ç¡®ç‚¹åï¼‰

åœ¨ä½  configureSession é‡Œï¼Œæœ‰ä¸¤ä¸ªå¿…é¡»å¯¹ç›´æ’­ç›´æ¥ return çš„é’©å­ï¼š

âŒ 1ï¸âƒ£ onBeforeSendHeaders â€”â€” è¿™é‡Œå¿…é¡»å¯¹ live ç›´é€š
ä½ ç°åœ¨çš„é—®é¢˜

ä½ åœ¨è¿™é‡Œåšäº†ï¼š

Cookie æ³¨å…¥

Referer / Origin é­”æ”¹

UA è¦†ç›–

ğŸ‘‰ è¿™äº›å¯¹ live éƒ½æ˜¯è‡´å‘½çš„

âœ… æ­£ç¡®æ”¹æ³•ï¼ˆç›´æ¥ç»™ä»£ç ï¼‰
sess.webRequest.onBeforeSendHeaders((details, callback) => {
  const url = details.url

  // ======== ç›´æ’­ä¸“ç”¨ï¼šé›¶åŠ«æŒç›´é€š ========
  if (
    url.includes('live.bilibili.com') ||
    url.includes('api.live.bilibili.com') ||
    url.includes('wss://') && url.includes('live')
  ) {
    return callback({ requestHeaders: details.requestHeaders })
  }
  // ====================================

  // â†“â†“â†“ ä¸‹é¢æ‰æ˜¯ä½ åŸæ¥çš„é€»è¾‘ï¼ˆæ™®é€šè§†é¢‘ / API æ‰èµ°ï¼‰ â†“â†“â†“

  const headers = details.requestHeaders

  // â€¦â€¦ä½ ç°æœ‰çš„ bilibili.com / api.bilibili.com / video é€»è¾‘ â€¦â€¦

  callback({ requestHeaders: headers })
})


ğŸ“Œ é‡ç‚¹ï¼š
åªè¦å‘½ä¸­ live â†’ ä¸€ä¸ªå­—éƒ½ä¸æ”¹ï¼ŒåŸæ ·æ”¾è¡Œã€‚

âŒ 2ï¸âƒ£ onHeadersReceived â€”â€” ç›´æ’­ç»å¯¹ä¸èƒ½åŠ¨

ä½ ç°åœ¨è¿™é‡Œåœ¨å¹²ä»€ä¹ˆï¼ŸğŸ‘‡

delete responseHeaders['content-security-policy']
delete responseHeaders['x-frame-options']


ğŸ‘‰ live çš„ WS / worker / iframe ä¼šç›´æ¥æ­»

âœ… æ­£ç¡®æ”¹æ³•
sess.webRequest.onHeadersReceived((details, callback) => {
  const url = details.url

  // ======== ç›´æ’­ä¸“ç”¨ï¼šé›¶åŠ«æŒç›´é€š ========
  if (
    url.includes('live.bilibili.com') ||
    url.includes('api.live.bilibili.com')
  ) {
    return callback({ responseHeaders: details.responseHeaders })
  }
  // ====================================

  const responseHeaders = details.responseHeaders || {}

  // â†“â†“â†“ ä¸‹é¢æ‰å¤„ç†æ™®é€š bilibili é¡µé¢ â†“â†“â†“
  if (url.includes('bilibili.com')) {
    delete responseHeaders['x-frame-options']
    delete responseHeaders['content-security-policy']
  }

  callback({ responseHeaders })
})


ğŸ“Œ è®°ä½ï¼š
ç›´æ’­é¡µé¢ = ä¸ç¢° CSPï¼Œä¸ç¢° XFOã€‚

ä¸‰ã€ã€Œç›´æ’­ä¸“ç”¨ï¼šé›¶åŠ«æŒã€session é…ç½®ï¼ˆå®Œæ•´ç¤ºä¾‹ï¼‰

å¦‚æœä½ æƒ³æ›´å¹²å‡€ï¼Œæˆ‘å»ºè®®ä½ ç›´æ¥æ‹†ï¼š

const defaultSession = win.webContents.session
const biliSession = session.fromPartition('persist:bilibili')


ç„¶åï¼š

function configureSession(sess: Electron.Session) {
  sess.setUserAgent(
    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) ' +
    'AppleWebKit/537.36 (KHTML, like Gecko) ' +
    'Chrome/122.0.0.0 Safari/537.36'
  )

  sess.webRequest.onBeforeSendHeaders((details, callback) => {
    const url = details.url

    // ===== LIVE: absolutely do nothing =====
    if (url.includes('live.bilibili.com') || url.includes('api.live.bilibili.com')) {
      return callback({ requestHeaders: details.requestHeaders })
    }

    // ===== éç›´æ’­ï¼šä½ åŸæ¥çš„é€»è¾‘ =====
    const headers = details.requestHeaders
    // â€¦â€¦
    callback({ requestHeaders: headers })
  })

  sess.webRequest.onHeadersReceived((details, callback) => {
    const url = details.url

    // ===== LIVE: do nothing =====
    if (url.includes('live.bilibili.com') || url.includes('api.live.bilibili.com')) {
      return callback({ responseHeaders: details.responseHeaders })
    }

    const responseHeaders = details.responseHeaders || {}
    // â€¦â€¦
    callback({ responseHeaders })
  })
}

å››ã€ä½ ç°åœ¨å¯ä»¥ ç›´æ¥åˆ æ‰ çš„ä¸œè¥¿ï¼ˆç›´æ’­åœºæ™¯ï¼‰

è¿™äº›æˆ‘æ˜ç¡®å‘Šè¯‰ä½ ï¼šå¯¹ç›´æ’­æ²¡ç”¨ï¼Œä¸”æœ‰å®³

âŒ å¯ä»¥åˆ 

preload-live.ts é‡Œå†™ document.cookie

X-Bili-Cookie è‡ªå®šä¹‰ header

live åœºæ™¯ä¸‹çš„ Referer / Origin æ‰‹åŠ¨è®¾ç½®

live åœºæ™¯ä¸‹çš„ CORS header æ³¨å…¥

âœ… ä¿ç•™

partition="persist:bilibili"

session.cookies.set(...)ï¼ˆåªåœ¨ç™»å½•å®Œæˆæ—¶ï¼‰

å®˜æ–¹ live é¡µé¢

visibility hidden çš„ CSS è£å‰ª