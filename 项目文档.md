# BiliCard 项目文档

## 1. 项目简介
BiliCard 是一个基于 Electron + React 的桌面端哔哩哔哩（Bilibili）第三方客户端。它采用“无限画布”设计理念，将视频、直播、动态等内容以卡片形式自由排列在桌面上，旨在提供沉浸式、无干扰的 B 站浏览体验。

## 2. 核心功能
*   **无限画布桌面**：用户可以在一个可缩放、拖拽的无限画布上自由放置和组织内容卡片。
*   **多类型卡片支持**：
    *   **推荐流卡片 (FeedCard)**：展示 B 站首页推荐视频流。
    *   **搜索卡片 (SearchCard)**：支持视频、直播间的关键词搜索。
    *   **视频详情卡片 (DetailCard)**：包含视频播放器（Webview 模式）、简介、相关视频推荐及评论区。
    *   **直播卡片 (LiveCard)**：展示正在直播的关注主播或推荐直播间。
    *   **直播播放卡片 (LivePlayer)**：纯净模式的直播播放器，自动屏蔽网页无关元素。
    *   **动态卡片 (DynamicCard)**：查看关注 UP 主的最新动态。
    *   **番剧卡片 (BangumiCard)**：展示热门番剧索引。
    *   **登录卡片 (LoginCard)**：支持二维码扫码登录，持久化保存 Cookie。
*   **沉浸式播放体验**：
    *   采用 Electron Webview 技术加载 B 站官方播放器。
    *   通过 CSS 注入（CSS Injection）自动隐藏网页端的 Header、Sidebar、广告及评论区，仅保留视频主体。
    *   支持视频与直播的纯净播放模式。
*   **桌面级交互**：
    *   窗口透明背景，与桌面壁纸融合。
    *   支持“鼠标穿透”模式：鼠标仅在卡片上响应，点击空白区域可直接操作下层窗口。
    *   卡片锁定功能：防止误触拖动。
    *   卡片自由缩放与排列。

## 3. 技术架构
### 3.1 技术栈
*   **核心框架**：Electron (主进程与渲染进程通信、窗口管理)
*   **前端框架**：React 18 + TypeScript
*   **构建工具**：Vite
*   **状态管理**：Zustand (管理卡片状态、用户信息、画布缩放等)
*   **样式库**：Tailwind CSS
*   **图标库**：Lucide React
*   **手势交互**：@use-gesture/react (实现画布与卡片的拖拽交互)

### 3.2 目录结构
```
e:\BiliCard\DesktopCanvas\
├── electron/             # Electron 主进程代码
│   ├── main.ts           # 应用入口、窗口创建、IPC 通信、网络拦截
│   └── preload.ts        # 预加载脚本，暴露 Node.js API 给渲染进程
├── src/                  # React 渲染进程代码
│   ├── components/       # UI 组件
│   │   ├── canvas/       # 画布组件
│   │   └── cards/        # 各类业务卡片组件 (feed, detail, live, etc.)
│   ├── services/         # 业务逻辑服务
│   │   └── bili-service.ts # Bilibili API 封装 (Axios + WBI 签名)
│   ├── store/            # Zustand 状态管理
│   │   ├── useCanvasStore.ts # 画布位移、缩放状态
│   │   ├── useCardStore.ts   # 卡片增删改查状态
│   │   └── useUserStore.ts   # 用户登录信息状态
│   └── utils/            # 工具函数 (IPC 鼠标穿透控制、WBI 签名算法)
└── ...
```

### 3.3 关键技术实现
*   **网络请求拦截与伪装**：
    *   在 `electron/main.ts` 中使用 `session.webRequest.onBeforeSendHeaders` 拦截请求。
    *   动态修改 `Referer` 和 `User-Agent`，绕过 B 站 API 的防盗链和风控。
    *   移除 `Origin` 头以解决部分 API 的跨域限制。
    *   移除 `X-Frame-Options` 和 `Content-Security-Policy` 响应头，允许 Webview 加载 B 站网页。
*   **Webview 纯净模式**：
    *   在 `VideoPlayer.tsx` 和 `LivePlayer.tsx` 中，利用 `<webview>` 标签加载目标 URL。
    *   监听 `dom-ready` 事件，注入 CSS 规则 (`insertCSS`) 将网页中除播放器以外的 DOM 元素设为 `display: none`。
    *   使用 `opacity` 过渡动画防止页面加载时的闪烁。
*   **WBI 签名**：
    *   实现了 B 站最新的 WBI (Web Browser Interface) 签名算法 (`utils/wbi.ts`)，用于请求用户信息、搜索等敏感 API。

## 4. 运行与构建
### 4.1 开发环境
1.  安装依赖：
    ```bash
    npm install
    ```
2.  启动开发服务器（同时启动 Vite 和 Electron）：
    ```bash
    npm run dev
    ```

### 4.2 打包构建
1.  构建生产环境代码：
    ```bash
    npm run build
    ```
    该命令会分别编译 React 前端代码（至 `dist` 目录）和 Electron 主进程代码（至 `dist-electron` 目录），并使用 `electron-builder` 生成可执行文件。

## 5. 常见问题与解决方案
*   **SSL 握手失败 (net_error -100)**：
    *   原因：Electron 默认的网络协议配置与 B 站部分 CDN 不兼容。
    *   解决：在 `main.ts` 中禁用 HTTP/2 和 QUIC (`disable-http2`, `disable-quic`)，并忽略证书错误。
*   **视频黑屏或透明**：
    *   原因：硬件加速在透明窗口下可能导致渲染异常。
    *   解决：视显卡驱动情况，可能需要禁用硬件加速 (`app.disableHardwareAcceleration()`)。
    *   *注：最新的 Electron 版本在部分系统上可能不需要禁用，需根据实际情况调整。*
*   **API 返回 -352/-412 错误**：
    *   原因：请求头校验失败（Referer/UA 不匹配或 WBI 签名错误）。
    *   解决：检查 `bili-service.ts` 中的 WBI 签名逻辑，并确保 `main.ts` 中的请求头拦截规则正确覆盖了 Referer。
