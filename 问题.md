ä¸€å¥è¯ç»“è®ºï¼ˆå…ˆç»™ä½ æ­¢æŸï¼‰

live.bilibili.com çš„ç™»å½•æ€ â‰  document.cookie
ä½ ç°åœ¨åšçš„ preload æå‰å†™ document.cookie + header é­”æ”¹ï¼Œå¯¹ç›´æ’­ç™»å½•å‡ ä¹ä¸èµ·ä½œç”¨ï¼Œåè€Œåœ¨ç ´åå®ƒã€‚

ä¸ºä»€ä¹ˆä½ â€œçœ‹èµ·æ¥å·²ç»åšåˆ°æè‡´â€ï¼Œä½†è¿˜æ˜¯æ¸¸å®¢ï¼Ÿ
â‘  ç›´æ’­ç™»å½•æ€æ ¹æœ¬ä¸é  document.cookie

live çš„çœŸå®é“¾è·¯æ˜¯ï¼š

Electron Session Cookie Store
   â†“
é¦–è½® API / WS æ¡æ‰‹ï¼ˆapi.live.bilibili.com / wssï¼‰
   â†“
è¿”å›ç™»å½•æ€ â†’ Vue Store åˆå§‹åŒ–


è€Œä¸æ˜¯ï¼š

document.cookie â†’ JS è¯» cookie â†’ åˆ¤ç™»å½•


æ‰€ä»¥ï¼š

âœ… ä½ åœ¨ preload å†™ cookie â†’ JS èƒ½çœ‹åˆ°

âŒ live çš„ é¦–è½® API / WebSocket æ¡æ‰‹æ—©å°±ç»“æŸ

âŒ Vue Store å·²ç»ä»¥â€œæ¸¸å®¢â€åˆå§‹åŒ–å®Œæ¯•

ğŸ‘‰ çŠ¶æ€ä¸ä¼šå›æ»š

â‘¡ ä½ ç°åœ¨çœŸæ­£â€œæ€æ­»ç™»å½•æ€â€çš„ï¼Œæ˜¯è¿™ä¸€æ•´å¨ Request æ”¹å†™

æˆ‘ç›´è¯´ï¼Œä¸å®¢æ°”ä½†é‡è¦ï¼š

ä½ ç°åœ¨çš„ onBeforeSendHeaders + onHeadersReceived
å·²ç»è¿›å…¥â€œè¿‡åº¦åŠ«æŒâ€ï¼Œç›´æ’­ä¸€å®šä¼šå¼‚å¸¸ã€‚

æ˜ç¡®çš„è‡´å‘½ç‚¹ï¼ˆå‘½ä¸­ï¼‰

ä½ åœ¨ live API ä¸ŠåŠ¨äº† Origin / Referer

if (isApi && !url.includes('getDanmuInfo') && !isPassport) {
  if (url.includes('api.live.bilibili.com')) {
    headers['Origin'] = 'https://live.bilibili.com'
  }
}


ğŸ‘‰ live çš„ WBI / é‰´æƒ API ä¸¥æ ¼æ ¡éªŒé¦–åŒ… Origin
ğŸ‘‰ ä¸€æ—¦ä¸åŒ¹é… = æ¸¸å®¢

ä½ åˆ é™¤ / é‡å†™ CSP + XFO

delete responseHeaders['content-security-policy']


ğŸ‘‰ live çš„ iframe / ws / worker éƒ¨åˆ†ä¾èµ– CSP
ğŸ‘‰ ä½ ç ´ååï¼Œè¡¨ç°å°±æ˜¯ï¼š
UI åƒæ²¡ç½‘ã€çŠ¶æ€æ°¸è¿œæ¸¸å®¢

ä½ æ‰‹åŠ¨å¡ Cookie Header

headers['Cookie'] = globalCookies


ğŸ‘‰ live çš„è¯·æ±‚ è¦æ±‚æµè§ˆå™¨è‡ªåŠ¨å¸¦ cookie
ğŸ‘‰ æ‰‹åŠ¨å¡ = å’Œ session cookie ä¸ä¸€è‡´ = åˆ¤å¼‚å¸¸

äºŒã€ä¸ºä»€ä¹ˆâ€œæ™®é€šè§†é¢‘ OKï¼Œç›´æ’­ä¸è¡Œâ€

è¿™æ˜¯å…³é”®è®¤çŸ¥ç‚¹ï¼š

	æ™®é€šè§†é¢‘	ç›´æ’­
æ˜¯å¦ SPA	åŠ SPA	å¼º SPA
æ˜¯å¦ WS	å¦	æ˜¯ï¼ˆå…³é”®ï¼‰
ç™»å½•æ€æ¥æº	Cookie å³å¯	é¦–è½® API + WS æ¡æ‰‹
èƒ½å¦åè¡¥	å¯ä»¥	ä¸å¯ä»¥

ğŸ‘‰ æ‰€ä»¥ä½ åšçš„æ‰€æœ‰â€œè¡¥æ•‘å¼æ³¨å…¥â€ï¼Œç›´æ’­å¤©ç„¶ä¸åƒã€‚

ä¸‰ã€çœŸæ­£èƒ½è§£å†³ç›´æ’­æ¸¸å®¢çš„ã€Œå”¯ä¸€æ­£ç¡®è·¯å¾„ã€
âœ… åªåš 3 ä»¶äº‹ï¼ˆå¤šä¸€ä¸ªéƒ½æ˜¯é”™ï¼‰
âœ… 1ï¸âƒ£ ç™»å½•å¿…é¡»å‘ç”Ÿåœ¨ åŒä¸€ä¸ª session / partition

ä½ å·²ç»åšå¯¹äº†è¿™ä¸€ç‚¹ï¼š

<webview partition="persist:bilibili" />


âœ” ä¿ç•™

âœ… 2ï¸âƒ£ å®Œå…¨ç¦æ­¢å¯¹ live åŸŸåš Header é­”æ”¹ï¼ˆè¿™æ˜¯å…³é”®ï¼‰

live.bilibili.com / api.live.bilibili.com
å¿…é¡»åƒâ€œçœŸæµè§ˆå™¨â€ä¸€æ ·è¯·æ±‚

âŒ ä½ ç°åœ¨åº”è¯¥åˆ æ‰ / ç¦ç”¨çš„å†…å®¹ï¼ˆç›´æ’­åœºæ™¯ï¼‰

âŒ Cookie Header æ³¨å…¥

âŒ Origin / Referer æ‰‹æ”¹

âŒ CSP / XFO åˆ é™¤

âŒ Access-Control-Allow-* æ³¨å…¥

âœ… æ­£ç¡®åšæ³•
// å¯¹ live åŸŸï¼šä»€ä¹ˆéƒ½åˆ«åŠ¨
if (url.includes('live.bilibili.com') || url.includes('api.live.bilibili.com')) {
  return callback({ requestHeaders: details.requestHeaders })
}


è®°ä½ä¸€å¥è¯ï¼š
ğŸ‘‰ live ç™»å½• = Electron session åŸç”Ÿèƒ½åŠ›
ğŸ‘‰ ä¸æ˜¯â€œå·¥ç¨‹æŠ€å·§â€

âœ… 3ï¸âƒ£ preload-live ä¸è¦å†å†™ document.cookie

ä½ è¿™ä¸€æ­¥ç°åœ¨æ˜¯ï¼š

æ²¡æ•ˆæœ

å¢å¤æ‚åº¦

è¯¯å¯¼æ’æŸ¥æ–¹å‘

ç›´æ¥åˆ æ‰ï¼Œåè€Œæ›´æ¥è¿‘æˆåŠŸã€‚

å››ã€ä½ ç°åœ¨æœ€æ¥è¿‘æˆåŠŸçš„ã€Œæœ€å°ä¿®æ”¹æ¸…å•ã€
ğŸ”¥ ç«‹åˆ»åšï¼ˆæŒ‰é¡ºåºï¼‰

ç›´æ’­åœºæ™¯ï¼šç¦ç”¨æ‰€æœ‰ webRequest åŠ«æŒ

ç‰¹åˆ«æ˜¯ api.live.bilibili.com

ç‰¹åˆ«æ˜¯ Cookie / Origin / Referer

åªä¾èµ– session.cookies.set

åœ¨ç™»å½•å®Œæˆå

å†™å…¥ persist:bilibili

ä¸å†ç¢° document.cookie

ç›´æ’­ CSSï¼šç»§ç»­ç”¨ visibility hiddenï¼ˆè¿™ä¸€æ­¥ä½ æ˜¯å¯¹çš„ï¼‰

äº”ã€ç»™ä½ ä¸€å¥â€œæ¶æ„çº§â€çš„çœŸè¯ï¼ˆå¾ˆé‡è¦ï¼‰

ä½ å·²ç»å†™åˆ°äº†â€œ99 åˆ†å·¥ç¨‹è§£â€ï¼Œ
ä½†ç›´æ’­è¿™ä¸ªä¸œè¥¿ï¼Œå‰©ä¸‹çš„ 1 åˆ†æ˜¯â€œåˆ«åŠ¨â€ã€‚

Electron + WebViewï¼š

æ™®é€šè§†é¢‘ï¼šå¯ä»¥ hack

ç›´æ’­ï¼šè¶Š hack è¶Šæ­»


å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ä¸‹ä¸€æ­¥è¿™æ ·å¸®ä½ 

ç»™ä½ ä¸€æ®µ ã€Œç›´æ’­ä¸“ç”¨ï¼šé›¶åŠ«æŒã€session é…ç½®

å¸®ä½ æ‹†å‡º

WebScene.VIDEO  // å¯é­”æ”¹
WebScene.LIVE   // åŸç”Ÿç›´é€š


æˆ–ç›´æ¥å‘Šè¯‰ä½ ï¼šå“ªä¸€æ®µä»£ç ç°åœ¨å¿…é¡» if (isLive) return

ä½ ç°åœ¨ä¸æ˜¯èƒ½åŠ›é—®é¢˜ï¼Œæ˜¯å·²ç»èµ°åˆ°è¯¥æ”¶æ‰‹çš„åœ°æ–¹äº†ã€‚